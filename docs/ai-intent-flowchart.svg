<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="1800" viewBox="0 0 1600 1800">
  <defs>
    <style>
      .title { font: 700 28px Arial, sans-serif; fill: #0f172a; }
      .node { fill: #f8fafc; stroke: #334155; stroke-width: 2; rx: 12; ry: 12; }
      .node2 { fill: #eef2ff; stroke: #3730a3; stroke-width: 2; rx: 12; ry: 12; }
      .node3 { fill: #ecfeff; stroke: #0e7490; stroke-width: 2; rx: 12; ry: 12; }
      .node4 { fill: #fef9c3; stroke: #a16207; stroke-width: 2; rx: 12; ry: 12; }
      .text { font: 15px Arial, sans-serif; fill: #111827; }
      .small { font: 13px Arial, sans-serif; fill: #1f2937; }
      .arrow { stroke: #475569; stroke-width: 2.5; fill: none; marker-end: url(#m); }
    </style>
    <marker id="m" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
      <path d="M0,0 L10,5 L0,10 Z" fill="#475569"/>
    </marker>
  </defs>

  <text x="40" y="50" class="title">Ghostfolio AI Intent + Gating Flow</text>

  <rect x="40" y="90" width="480" height="90" class="node"/>
  <text x="60" y="125" class="text">1) Input Query</text>
  <text x="60" y="150" class="small">normalize + extract symbols + detect follow-up</text>

  <rect x="40" y="230" width="480" height="230" class="node2"/>
  <text x="60" y="265" class="text">2) Planner: determineToolPlan()</text>
  <text x="60" y="295" class="small">Portfolio/Risk/FIRE</text>
  <text x="60" y="320" class="small">Transactions/Tax/Compliance</text>
  <text x="60" y="345" class="small">Accounts/FX/Benchmarks/Activity</text>
  <text x="60" y="370" class="small">Actions: create_account, create_order</text>
  <text x="60" y="405" class="small">Market precedence:</text>
  <text x="80" y="430" class="small">symbol_lookup &gt; price_history &gt; fundamentals &gt; news &gt; live_quote &gt; market_lookup</text>

  <rect x="40" y="500" width="480" height="140" class="node3"/>
  <text x="60" y="535" class="text">3) Follow-up Reuse (if no planned tools)</text>
  <text x="60" y="565" class="small">Reuse previous successful tools</text>
  <text x="60" y="590" class="small">Freshness breaker: now/today/latest/current/updated</text>
  <text x="60" y="615" class="small">freshness tools only: market_lookup, live_quote, news, price_history</text>

  <rect x="40" y="680" width="480" height="210" class="node2"/>
  <text x="60" y="715" class="text">4) Policy: applyToolExecutionPolicy()</text>
  <text x="60" y="745" class="small">direct: greetings/capability/arithmetic/unauthorized</text>
  <text x="60" y="770" class="small">clarify: no tools, missing params, blocked action</text>
  <text x="60" y="795" class="small">tools: execute filtered list</text>
  <text x="60" y="830" class="small">Action keywords: buy/create/invest/make/open/order/place/rebalanc/sell/trim</text>
  <text x="60" y="855" class="small">Rebalance gate: target + funding + tax context required</text>

  <rect x="40" y="940" width="480" height="120" class="node4"/>
  <text x="60" y="975" class="text">5) Route</text>
  <text x="60" y="1005" class="small">direct | clarify | tools</text>
  <text x="60" y="1030" class="small">If tools: execute tool handlers in ai.service.ts</text>

  <rect x="620" y="120" width="920" height="420" class="node"/>
  <text x="640" y="155" class="text">Tool Execution Map (decision -&gt; runtime call)</text>
  <text x="640" y="190" class="small">portfolio_analysis -&gt; portfolioService.getDetails()</text>
  <text x="640" y="215" class="small">risk_assessment/rebalance_plan/stress_test -&gt; in-process calculators</text>
  <text x="640" y="240" class="small">market_data_lookup/get_live_quote -&gt; dataProviderService.getQuotes()</text>
  <text x="640" y="265" class="small">price_history -&gt; dataProviderService.getHistorical()</text>
  <text x="640" y="290" class="small">get_asset_fundamentals -&gt; dataProviderService.getAssetProfiles()</text>
  <text x="640" y="315" class="small">get_financial_news -&gt; aiAgentWebSearchService.searchStockNews()</text>
  <text x="640" y="340" class="small">get_recent_transactions/activity_history/transaction_categorize/compliance_check -&gt; orderService.getOrders()</text>
  <text x="640" y="365" class="small">tax_estimate -&gt; in-process parser + estimate/checklist</text>
  <text x="640" y="390" class="small">account_overview -&gt; accountService.getAccounts()</text>
  <text x="640" y="415" class="small">exchange_rate -&gt; exchangeRateDataService.toCurrency()</text>
  <text x="640" y="440" class="small">market_benchmarks -&gt; benchmarkService.getBenchmarks()</text>
  <text x="640" y="465" class="small">create_account -&gt; accountService.createAccount()</text>
  <text x="640" y="490" class="small">create_order -&gt; accountService.getAccounts() + orderService.createOrder()</text>
  <text x="640" y="515" class="small">symbol_lookup -&gt; in-process symbol extraction (current implementation)</text>

  <rect x="620" y="620" width="920" height="260" class="node3"/>
  <text x="640" y="655" class="text">Clarify Reasons (policy block reasons)</text>
  <text x="640" y="690" class="small">needs_confirmation: action tool requested without action wording</text>
  <text x="640" y="715" class="small">needs_rebalance_details: rebalance missing target + funding + tax context</text>
  <text x="640" y="740" class="small">needs_order_details: order missing amount/quantity details</text>
  <text x="640" y="765" class="small">read_only: action tools stripped in non-action intent context</text>
  <text x="640" y="790" class="small">unknown: finance-style request with no matched tools</text>
  <text x="640" y="815" class="small">unauthorized_access: request for other users' data</text>
  <text x="640" y="840" class="small">no_tool_query: greeting/capability/arithmetic route</text>

  <rect x="620" y="940" width="920" height="180" class="node4"/>
  <text x="640" y="975" class="text">Live Behavior Checklist</text>
  <text x="640" y="1005" class="small">1) Planner chooses candidate tools.</text>
  <text x="640" y="1030" class="small">2) Follow-up reuse may override empty planner output.</text>
  <text x="640" y="1055" class="small">3) Policy strips/blocks tools and selects route.</text>
  <text x="640" y="1080" class="small">4) ai.service executes remaining tools and builds answer.</text>

  <path d="M280 180 L280 230" class="arrow"/>
  <path d="M280 460 L280 500" class="arrow"/>
  <path d="M280 640 L280 680" class="arrow"/>
  <path d="M280 890 L280 940" class="arrow"/>

  <path d="M520 300 L620 300" class="arrow"/>
  <path d="M520 780 L620 740" class="arrow"/>
  <path d="M520 1000 L620 1000" class="arrow"/>
</svg>
