<mat-card appearance="outlined">
  <mat-card-content>
    <div class="mb-3">
      <h2 class="h5 mb-1" i18n>AI Retirement Assistant</h2>
      <p class="mb-0 text-muted" i18n>
        Ask questions about your FIRE plan, retirement scenarios, and withdrawal
        strategies.
      </p>
    </div>

    @if (!hasPermissionToReadAiPrompt) {
      <div class="alert alert-warning mb-0" i18n role="alert">
        You need AI prompt permission to use this assistant.
      </div>
    } @else {
      <div class="d-flex flex-wrap mb-3 prompt-list">
        @for (prompt of starterPrompts; track prompt) {
          <button
            class="mr-2 mb-2"
            mat-stroked-button
            type="button"
            (click)="onSelectStarterPrompt(prompt)"
          >
            {{ prompt }}
          </button>
        }
      </div>

      <mat-form-field class="w-100">
        <mat-label i18n>Ask about your retirement plan</mat-label>
        <textarea
          aria-label="Ask about your retirement plan"
          i18n-aria-label
          matInput
          rows="3"
          [disabled]="isSubmitting"
          [(ngModel)]="query"
          (keydown.enter)="onSubmitFromKeyboard($event)"
        ></textarea>
      </mat-form-field>

      <div class="align-items-center d-flex mb-3">
        <button
          color="primary"
          mat-flat-button
          type="button"
          [disabled]="isSubmitting || !query?.trim()"
          (click)="onSubmit()"
        >
          <ng-container i18n>Send</ng-container>
        </button>
        @if (isSubmitting) {
          <mat-spinner class="ml-3" color="accent" [diameter]="20" />
        }
      </div>

      @if (errorMessage) {
        <div class="alert alert-danger mb-3" role="alert">
          {{ errorMessage }}
        </div>
      }

      <div
        aria-live="polite"
        aria-relevant="additions text"
        class="chat-log"
        role="log"
      >
        @for (message of visibleMessages; track message.id) {
          <div
            class="chat-message mb-3 p-3 rounded"
            [class.assistant]="message.role === 'assistant'"
            [class.user]="message.role === 'user'"
          >
            <div class="chat-message-header mb-1 text-muted">
              <span class="role-label text-uppercase">{{
                getRoleLabel(message.role)
              }}</span>
              <span class="ml-2 timestamp">{{
                message.createdAt | date: 'mediumTime'
              }}</span>

              @if (message.role === 'assistant' && message.response) {
                <button
                  aria-label="Show response details"
                  class="chat-details-trigger ml-2"
                  i18n-aria-label
                  mat-icon-button
                  type="button"
                  [matMenuTriggerFor]="responseDetailsMenu"
                  (click)="onOpenResponseDetails(message.response)"
                >
                  <svg
                    aria-hidden="true"
                    class="chat-details-icon"
                    fill="none"
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" x2="12" y1="16" y2="12" />
                    <line x1="12" x2="12.01" y1="8" y2="8" />
                  </svg>
                </button>
              }
            </div>
            <div class="chat-message-content">{{ message.content }}</div>

            @if (message.feedback) {
              <div class="align-items-center d-flex feedback-controls mt-2">
                <span class="feedback-label" i18n>Rate this response:</span>
                <mat-form-field
                  appearance="outline"
                  class="feedback-comment-field mr-2"
                  subscriptSizing="dynamic"
                >
                  <mat-label i18n>Comment</mat-label>
                  <input
                    matInput
                    type="text"
                    [disabled]="
                      message.feedback.isSubmitting || !!message.feedback.rating
                    "
                    [ngModel]="message.feedback.comment ?? ''"
                    (ngModelChange)="
                      onFeedbackCommentChange({
                        comment: $event,
                        messageId: message.id
                      })
                    "
                  />
                </mat-form-field>
                <button
                  class="mr-2"
                  mat-stroked-button
                  type="button"
                  [disabled]="
                    message.feedback.isSubmitting || !!message.feedback.rating
                  "
                  (click)="
                    onRateResponse({ messageId: message.id, rating: 'up' })
                  "
                >
                  <ng-container i18n>Helpful</ng-container>
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  [disabled]="
                    message.feedback.isSubmitting || !!message.feedback.rating
                  "
                  (click)="
                    onRateResponse({ messageId: message.id, rating: 'down' })
                  "
                >
                  <ng-container i18n>Needs work</ng-container>
                </button>

                @if (message.feedback.isSubmitting) {
                  <span class="ml-2 text-muted" i18n>Saving feedback...</span>
                } @else if (message.feedback.feedbackId) {
                  <span class="ml-2 text-muted" i18n>Feedback saved</span>
                }
              </div>
            }
          </div>
        }
      </div>

      <mat-menu
        #responseDetailsMenu="matMenu"
        class="no-max-width"
        xPosition="before"
      >
        <div
          class="response-details-panel p-3"
          (click)="$event.stopPropagation()"
        >
          @if (activeResponseDetails; as details) {
            <div class="response-details-section">
              <strong i18n>Confidence</strong>:
              {{ details.confidence.score * 100 | number: '1.0-0' }}% ({{
                details.confidence.band
              }})
            </div>

            @if (details.llmInvocation) {
              <div class="response-details-section">
                <strong i18n>LLM</strong>:
                <span class="ml-1">{{ details.llmInvocation.provider }}</span>
                <span class="ml-1">({{ details.llmInvocation.model }})</span>
              </div>
            }

            @if (details.toolCalls.length > 0) {
              <div class="response-details-section">
                <strong i18n>Tools</strong>
                <ul class="mb-0 pl-3 response-details-list">
                  @for (toolCall of details.toolCalls; track $index) {
                    <li>
                      <span class="font-weight-bold">{{ toolCall.tool }}</span>
                      -
                      {{ toolCall.status }}
                      @if (toolCall.durationInMs !== undefined) {
                        <span class="ml-1 text-muted">
                          (duration: {{
                            formatToolCallDuration(toolCall.durationInMs)
                          }})
                        </span>
                      }
                      <div>
                        <span class="text-muted" i18n>Input</span>:
                        {{ toolCall.input | json }}
                      </div>
                      <div>
                        <span class="text-muted" i18n>Output</span>:
                        {{ toolCall.outputSummary }}
                      </div>
                    </li>
                  }
                </ul>
              </div>
            }

            @if (details.citations.length > 0) {
              <div class="response-details-section">
                <strong i18n>Citations</strong>
                <ul class="mb-0 pl-3 response-details-list">
                  @for (citation of details.citations; track $index) {
                    <li>
                      <span class="font-weight-bold">{{
                        citation.source
                      }}</span>
                      -
                      {{ citation.snippet }}
                    </li>
                  }
                </ul>
              </div>
            }

            @if (details.verification.length > 0) {
              <div class="response-details-section">
                <strong i18n>Verification</strong>
                <ul class="mb-0 pl-3 response-details-list">
                  @for (check of details.verification; track $index) {
                    <li>
                      <span class="text-capitalize">{{ check.status }}</span>
                      -
                      {{ check.check }}:
                      {{ check.details }}
                    </li>
                  }
                </ul>
              </div>
            }

            @if (details.observability) {
              <div class="response-details-section">
                <strong i18n>Observability</strong>:
                <span class="ml-1"
                  >{{ details.observability.latencyInMs }}ms, ~{{
                    details.observability.tokenEstimate.total
                  }}
                  tokens</span
                >
                @if (details.observability.traceId) {
                  <div class="response-details-trace">
                    <strong i18n>Trace ID</strong>:
                    <span class="ml-1">{{
                      details.observability.traceId
                    }}</span>
                  </div>
                }
              </div>
            }
          } @else {
            <span class="text-muted" i18n>No response details available.</span>
          }
        </div>
      </mat-menu>
    }
  </mat-card-content>
</mat-card>
